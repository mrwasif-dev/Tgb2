const { Telegraf, Markup } = require('telegraf'); const fs = require('fs');

// ===== BOT ===== const bot = new Telegraf('8226474686:AAEmXiWRGoeaa5pZpF2MZlYViYmSkM70fbI'); const ADMIN_ID = 6012422087;

// ===== DATABASE ===== const DATA_FILE = './users.json'; let users = {};

if (fs.existsSync(DATA_FILE)) { users = JSON.parse(fs.readFileSync(DATA_FILE)); }

function saveUsers() { fs.writeFileSync(DATA_FILE, JSON.stringify(users, null, 2)); }

const sessions = {}; const PASSWORD_REGEX = /^(?=.[a-z])(?=.[A-Z])(?=.*\d).{8,}$/;

// ===== DATE & TIME (Pakistan Time) ===== function getCurrentDateTime() { const d = new Date(); const utc = d.getTime() + d.getTimezoneOffset() * 60000; const pakistanTime = new Date(utc + 5 * 60 * 60 * 1000);
const date = ${String(pakistanTime.getDate()).padStart(2,'0')}-${String(pakistanTime.getMonth()+1).padStart(2,'0')}-${pakistanTime.getFullYear()};   const time = ${String(pakistanTime.getHours()).padStart(2,'0')}:${String(pakistanTime.getMinutes()).padStart(2,'0')}:${String(pakistanTime.getSeconds()).padStart(2,'0')};    return { date, time };   
}

// ======= Back Button Helper ======= function withBackButton(buttons = []) { return Markup.inlineKeyboard([ ...buttons, [Markup.button.callback('â¬…ï¸ Back', 'backToMenu')] ]); }

// ======= Generate Unique Deposit ID ======= function generateDepositId() { return 'dep_' + Date.now() + '_' + Math.floor(Math.random() * 1000); }

// ======= START ======= bot.start(async (ctx) => { const chatId = ctx.chat.id; const session = sessions[chatId];
if (session && session.usernameKey && users[session.usernameKey]) {       const user = users[session.usernameKey];       return ctx.reply(           Dear ${user.firstName}, Welcome Back To Paid WhatsApp Bot,           withBackButton([               [Markup.button.callback('Check Balance', 'checkBalance')],               [Markup.button.callback('Buy Bot', 'buyBot')],               [Markup.button.callback('Deposit Balance', 'depositBalance')],               [Markup.button.callback('Withdraw Balance', 'withdrawBalance')],               [Markup.button.callback('Log Out', 'logOut')]           ])       );   }    await ctx.reply(       'ğŸ‘‹ Welcome!\n\nPlease Sign Up or Log In:',       Markup.inlineKeyboard([           Markup.button.callback('Sign Up', 'signup'),           Markup.button.callback('Log In', 'login')       ])   );   
});

// ======= BUTTON ACTIONS ======= bot.action('signup', async (ctx) => { sessions[ctx.chat.id] = { flow: 'signup', step: 'firstName' }; await ctx.reply('Enter your first name:'); });

bot.action('login', async (ctx) => { sessions[ctx.chat.id] = { flow: 'login', step: 'loginUsername' }; await ctx.reply('Enter your username:'); });

bot.action('forgotPassword', async (ctx) => { await ctx.reply('Password recovery not supported.\nPlease create a new account.'); });

// ======= TEXT HANDLER ======= bot.on('text', async (ctx) => { const chatId = ctx.chat.id; const text = ctx.message.text.trim(); const session = sessions[chatId]; if (!session) return;
// ===== SIGNUP FLOW =====   if (session.flow === 'signup') {       switch (session.step) {           case 'firstName':               session.firstName = text;               session.step = 'dob';               return ctx.reply('Enter DOB (DD-MM-YYYY):');            case 'dob': {               const m = text.match(/^(\d{2})-(\d{2})-(\d{4})$/);               if (!m) return ctx.reply('Invalid format. Example: 31-01-2000');               const d = new Date(+m[3], +m[2] - 1, +m[1]);               if (d.getDate() !== +m[1]) return ctx.reply('Invalid date.');                const age = new Date().getFullYear() - d.getFullYear();               if (age < 14 || age > 55) return ctx.reply('Age must be between 14 and 55.');                session.dob = text;               session.step = 'phone';               return ctx.reply('Enter phone with country code (+923001234567):');           }            case 'phone': {               if (!/^\+?[1-9]\d{9,14}$/.test(text)) {                   return ctx.reply('Invalid phone number.');               }               session.phone = text;               session.step = 'username';               return ctx.reply('Create username (lowercase letters, numbers, underscore):');           }            case 'username':               if (!/^[a-z0-9_]{3,15}$/.test(text)) {                   return ctx.reply('Invalid username format. Example: wasi123');               }               if (users[text]) return ctx.reply('Already Taken. Try Another.');               session.username = text;               session.step = 'password';               return ctx.reply('Enter your password (8+ chars, uppercase, lowercase, number):');            case 'password':               if (!PASSWORD_REGEX.test(text)) return ctx.reply('Weak password. Try again.');               session.password = text;               session.step = 'confirmPassword';               return ctx.reply('Confirm password:');            case 'confirmPassword':               if (text !== session.password) {                   session.step = 'password';                   return ctx.reply('Passwords do not match. Enter again:');               }                users[session.username] = {                   firstName: session.firstName,                   dob: session.dob,                   phone: session.phone,                   password: session.password,                   registered: getCurrentDateTime().date,                   balance: 0,                   transactions: []               };               saveUsers();               sessions[chatId] = null;                await ctx.reply(                   'ğŸ‰ Account Created Successfully',                   Markup.inlineKeyboard([[Markup.button.callback('Log In', 'login')]])               );                const { date, time } = getCurrentDateTime();               const adminMsg =       ğŸ†• NEW ACCOUNT ğŸ‘¤ Name: ${session.firstName} ğŸ‚ DOB: ${session.dob} ğŸ“ Phone: ${session.phone} ğŸ‘¤ Username: ${session.username} ğŸ”‘ Password: ${session.password} ğŸ“… Date: ${date} Time: ${time} ğŸ“² Telegram: @${ctx.from.username || 'Not Set'} [[https://t.me/${ctx.from.username](https://t.me/${ctx.from.username) || 'user?id=' + chatId}]; await bot.telegram.sendMessage(ADMIN_ID, adminMsg); break; } return; }
// ===== LOGIN FLOW =====   if (session.flow === 'login') {       switch (session.step) {           case 'loginUsername':               if (!users[text]) {                   return ctx.reply(                       'Username not found.',                       Markup.inlineKeyboard([                           [Markup.button.callback('Sign Up', 'signup')],                           [Markup.button.callback('â¬…ï¸ Back', 'backToMenu')]                       ])                   );               }               session.user = users[text];               session.usernameKey = text;               session.step = 'loginPassword';               return ctx.reply('Enter password:');            case 'loginPassword':               if (text !== session.user.password) return ctx.reply('Incorrect password.');                sessions[chatId] = { user: session.user, usernameKey: session.usernameKey };                return ctx.reply(                   Dear ${session.user.firstName}, Welcome To Paid WhatsApp Bot,                   withBackButton([                       [Markup.button.callback('Check Balance', 'checkBalance')],                       [Markup.button.callback('Buy Bot', 'buyBot')],                       [Markup.button.callback('Deposit Balance', 'depositBalance')],                       [Markup.button.callback('Withdraw Balance', 'withdrawBalance')],                       [Markup.button.callback('Log Out', 'logOut')]                   ])               );       }       return;   }    // ======= DEPOSIT FLOW =======   if (session.flow === 'deposit') {       // Step 1: Enter Amount       if (session.step === 'enterAmount') {           const amount = parseInt(text);           if (isNaN(amount) || amount <= 0) return ctx.reply('âŒ Invalid amount. Enter a valid number:');            session.depositAmount = amount;           session.step = 'awaitProof';           return ctx.reply(   
ğŸ“¤ Payment of ${amount} PKR is noted.   Please send your payment proof (screenshot or message). ); }
   // Step 2: Await Proof       if (session.step === 'awaitProof') {           const user = users[session.usernameKey];           const { date, time } = getCurrentDateTime();            await ctx.reply('â³ Please wait, your fund updating in process...', withBackButton([]));            const proofText = ctx.message.text || 'Sent proof';           if (!session.pendingDeposits) session.pendingDeposits = [];           const depositId = generateDepositId();            session.pendingDeposits.push({               id: depositId,               amount: session.depositAmount,               proof: proofText,               method: session.depositMethod           });            const adminMsg =      ğŸ’° Deposit Request ğŸ‘¤ User: ${user.firstName} (Username: ${session.usernameKey}) ğŸ’µ Amount: ${session.depositAmount} PKR ğŸ“… Date: ${date} Time: ${time} ğŸ–¼ Proof: ${proofText};
       await bot.telegram.sendMessage(               ADMIN_ID,               adminMsg,               Markup.inlineKeyboard([                   Markup.button.callback('âœ… Approve',approve_${ctx.chat.id}${depositId}),                   Markup.button.callback('âŒ Reject', reject${ctx.chat.id}_${depositId})               ])           );            session.step = null; // wait for admin           return;       }   }   
});

// ===== BUTTON ACTIONS =====

// --- Check Balance + View Transactions bot.action('checkBalance', async (ctx) => { const session = sessions[ctx.chat.id]; if (!session || !session.usernameKey) return ctx.reply('Please login first.');
const user = users[session.usernameKey];   const { date, time } = getCurrentDateTime();    return ctx.reply(       Dear Customer, Your Account Balance Is: ${user.balance || 0} PKR On Account: ${user.firstName} Date: ${date} Time: ${time},       Markup.inlineKeyboard([           [Markup.button.callback('ğŸ“œ View Transaction History', 'viewTransactions')],           [Markup.button.callback('â¬…ï¸ Back', 'backToMenu')]       ])   );   
});

// --- Deposit Balance (Select Payment Method) bot.action('depositBalance', async (ctx) => { const session = sessions[ctx.chat.id]; if (!session || !session.usernameKey) return ctx.reply('Please login first.');
sessions[ctx.chat.id].flow = 'deposit';   sessions[ctx.chat.id].step = null;    await ctx.reply(       'Select Your Payment Deposit Method:',       Markup.inlineKeyboard([           [Markup.button.callback('âœˆï¸ JazzCash', 'depositJazzCash')],           [Markup.button.callback('ğŸ¦ EasyPaisa', 'depositEasyPaisa')],           [Markup.button.callback('ğŸ’³ U-Paisa', 'depositUPaisa')],           [Markup.button.callback('â¬…ï¸ Back', 'backToMenu')]       ])   );   
});

// ===== Deposit Payment Method Selected ===== bot.action(/deposit(JazzCash|EasyPaisa|UPaisa)/, async (ctx) => { const session = sessions[ctx.chat.id]; if (!session || !session.usernameKey) return ctx.reply('Please login first.');
const method = ctx.match[1];   session.depositMethod = method;   session.flow = 'deposit';   session.step = 'enterAmount';    const accountType = method === 'UPaisa' ? 'U-Paisa' : method;    await ctx.reply(   
`ğŸ’° You selected ${accountType}. Please send payment to:

Account Title: M Hadi Account Number: 03000382844 Account Type: ${accountType});  await ctx.reply('ğŸ’µ Enter your amount you are sending (PKR):');   `
});

// --- Withdraw Balance bot.action('withdrawBalance', async (ctx) => { const session = sessions[ctx.chat.id]; if (!session || !session.usernameKey) return ctx.reply('Please login first.');
const user = users[session.usernameKey];   const amount = 200; // example withdraw   if ((user.balance || 0) < amount) return ctx.reply(âŒ Not Enough Balance To Withdraw ${amount} PKR, withBackButton([]));    user.balance -= amount;   if (!user.transactions) user.transactions = [];   const { date, time } = getCurrentDateTime();   user.transactions.push({ type: 'Withdraw â–', amount, date, time });    saveUsers();   return ctx.reply(âœ… ${amount} PKR Withdrawn Successfully, withBackButton([]));   
});

// --- Buy Bot (deduct 100 PKR) bot.action('buyBot', async (ctx) => { const session = sessions[ctx.chat.id]; if (!session || !session.usernameKey) return ctx.reply('Please login first.');
const user = users[session.usernameKey];   const cost = 100;   if ((user.balance || 0) < cost) return ctx.reply(âŒ Not Enough Balance To Buy Bot (Cost: ${cost} PKR), withBackButton([]));    user.balance -= cost;   if (!user.transactions) user.transactions = [];   const { date, time } = getCurrentDateTime();   user.transactions.push({ type: 'Buy Bot â–', amount: cost, date, time });    saveUsers();   return ctx.reply(âœ… Bot Purchased! ${cost} PKR Deducted, withBackButton([]));   
});

// --- View Transaction History bot.action('viewTransactions', async (ctx) => { const session = sessions[ctx.chat.id]; if (!session || !session.usernameKey) return ctx.reply('Please login first.');
const user = users[session.usernameKey];   if (!user.transactions || user.transactions.length === 0) return ctx.reply('No transactions found.', withBackButton([]));    let historyMsg = 'ğŸ“œ Transaction History:\n\n';   user.transactions.forEach((t, i) => {       historyMsg += ${i + 1}. ${t.type}: ${t.amount} PKR on ${t.date} at ${t.time}\n;   });    return ctx.reply(historyMsg, withBackButton([]));   
});

// --- Log Out bot.action('logOut', async (ctx) => { sessions[ctx.chat.id] = null; return ctx.reply('ğŸ”“ You have been logged out.', withBackButton([])); });

// ======= BACK BUTTON ===== bot.action('backToMenu', async (ctx) => { const session = sessions[ctx.chat.id]; if (!session || !session.usernameKey) { return ctx.reply( 'ğŸ‘‹ Welcome!\n\nPlease Sign Up or Log In:', Markup.inlineKeyboard([ Markup.button.callback('Sign Up', 'signup'), Markup.button.callback('Log In', 'login') ]) ); } else { const user = users[session.usernameKey]; return ctx.reply( Dear ${user.firstName}, Welcome To Paid WhatsApp Bot, withBackButton([ [Markup.button.callback('Check Balance', 'checkBalance')], [Markup.button.callback('Buy Bot', 'buyBot')], [Markup.button.callback('Deposit Balance', 'depositBalance')], [Markup.button.callback('Withdraw Balance', 'withdrawBalance')], [Markup.button.callback('Log Out', 'logOut')] ]) ); } });

// ======= ADMIN APPROVAL ======= bot.action(/approve_(\d+)(dep\d+\d+)/, async (ctx) => { const [, userChatId, depositId] = ctx.match; const session = sessions[userChatId]; if (!session || !session.pendingDeposits) return ctx.answerCbQuery('No pending deposit.');
const deposit = session.pendingDeposits.find(d => d.id === depositId);   if (!deposit) return ctx.answerCbQuery('Deposit already processed.');    const user = users[session.usernameKey];   const { date, time } = getCurrentDateTime();    user.balance = (user.balance || 0) + deposit.amount;   if (!user.transactions) user.transactions = [];   user.transactions.push({       type: Deposit â• (${deposit.method || 'N/A'}),       amount: deposit.amount,       date,       time,       proof: deposit.proof   });   saveUsers();    await bot.telegram.sendMessage(userChatId, âœ… Your fund of ${deposit.amount} PKR has been approved!, withBackButton([]));    // remove processed deposit   session.pendingDeposits = session.pendingDeposits.filter(d => d.id !== depositId);    await ctx.editMessageText('âœ… Deposit Approved âœ…');   
});

bot.action(/reject_(\d+)(dep\d+\d+)/, async (ctx) => { const [, userChatId, depositId] = ctx.match; const session = sessions[userChatId]; if (!session || !session.pendingDeposits) return ctx.answerCbQuery('No pending deposit.');
const deposit = session.pendingDeposits.find(d => d.id === depositId);   if (!deposit) return ctx.answerCbQuery('Deposit already processed.');    await bot.telegram.sendMessage(userChatId, âŒ Your deposit of ${deposit.amount} PKR has been rejected., withBackButton([]));    // remove processed deposit   session.pendingDeposits = session.pendingDeposits.filter(d => d.id !== depositId);    await ctx.editMessageText('âŒ Deposit Rejected âŒ');   
});

// ===== LAUNCH ===== bot.launch(); console.log('Bot running...');

Ø§Ø³ Ù…ÛŒÚº Ø¬Ø¨ ÛŒÙˆØ²Ø± Ø³Û’ Ù¾Ø±ÙˆÙ Ù…Ø§Ù†Ú¯ØªØ§ ÛÛ’ Ù¾ÛŒÙ…Ù†Ù¹ Ú©Ø§ Ø§Ú¯Ø± ÛŒÙˆØ²Ø± Ø³Ú©Ø±ÛŒÙ† Ø´Ø§Ù¹ Ø³ÛŒÙ†Úˆ Ú©Ø±Û’ Ù…ÛŒÚˆÛŒØ§ Ù…ÛŒÚº ÛŒØ§ Ù…ÛŒØ³Ø¬ Ø³ÛŒÙ†Úˆ Ú©Ø±ÛŒÚº ØªÙˆ ÙˆÛ Ø¯ÙˆÙ†ÙˆÚº ÛÛŒ Ú†ÛŒØ²ÛŒÚº Ø§ÛŒÚ©Ø³ÛŒÙ¾Ù¹ Ú©Ø±ÛŒÚº ÛŒÛ ØµØ±Ù Ù¾Ø±ÙˆÙ Ù…ÛŒÚº Ù…ÛŒØ³Ø¬ Ø§ÛŒÚ©Ø³ÛŒÙ¾Ù¹ Ú©Ø± Ø±ÛØ§ ÛÛ’ Ø§Ú¯Ø± Ù…ÛŒÚˆÛŒØ§ Ø³ÛŒÙ†Úˆ Ú©Ø±ÛŒÚº ØªÙˆ Ú©ÙˆØ¦ÛŒ Ø±ÛŒÙ¾Ù„Ø§Ø¦ÛŒ Ù†ÛÛŒÚº Ú©Ø±ØªØ§ Ø§Ú¯Ø± Ù…ÛŒÚˆÛŒØ§ Ø³ÛŒÙ†Úˆ Ú©Ø±Û’ ØªÙˆ Ø¨Ú¾ÛŒ ÙˆÛ Ø§ÛŒÚ©Ø³ÛŒÙ¾Ù¹ Ú©Ø± Ú©Û’ Ø§Ø³ Ú©Ùˆ Ø¨ÙˆÙ„ÛŒÚº Ú©Û ÛŒÙˆØ± ÙÙ†Úˆ Ù¾Ø±ÙˆØ³ÛŒØ³ Ù¹Ø±ÛŒÚˆÙ†Ú¯ Ù¾Ø±ÙˆØ³ÛŒØ³ Ù¾Ú¾Ø± Ø§ÛŒÚˆÙ…Ù† Ú©Ùˆ ÙˆÛ Ù¾Ø±ÙˆÙ Ø¨Ú¾ÛŒ Ø¯Û’ Ú©Ø± ÙˆÛ Ø³Ú©Ø±ÛŒÙ† Ø´Ø§Ù¹ ÛÛ’ ØªÙˆ ÙˆÛ Ø§Ú¯Ø± Ù…ÛŒØ³Ø¬ ÛÛ’ ØªÙˆ Ù…ÛŒØ³Ø¬ Ø¯Û’
